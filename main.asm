;==============================================================
; WLA-DX banking setup
;==============================================================
.memorymap
   defaultslot 0
   ; ROM area
   slotsize        $4000
   slot            0       $0000
   slot            1       $4000
   slot            2       $8000
   ; RAM area
   slotsize        $2000
   slot            3       $C000
   slot            4       $E000
.endme


.rombankmap
bankstotal 1
banksize $4000
banks 1
.endro

;==============================================================
; RAM section
;==============================================================
.ramsection "variables" slot 3
compteur                     db
.ends


;==============================================================
; SDSC tag and SMS rom header
;==============================================================
.sdsctag 1.2,"Hello World!","SMS programming tutorial program","Maxim"

.bank 0 slot 0
.org $0000
;==============================================================
; Boot section
;==============================================================
    di              ; disable interrupts
    im 1            ; Interrupt mode 1
    jp main         ; jump to main program

.org $0066
;==============================================================
; Pause button handler
;==============================================================
    ; Do nothing
    retn


;inclusions
.include "init.inc"


;==============================================================
; Main program
;==============================================================
main:
    ld sp, $dff0 ;where stack ends

    ;==============================================================
    ; Set up VDP registers
    ;==============================================================
    ;ld hl,VdpData
    ;ld b,VdpDataEnd-VdpData
    ;ld c,$bf
    ;otir


    call initVDP



    ;==============================================================
    ; Clear VRAM
    ;==============================================================
    ; 1. Set VRAM write address to 0 by outputting $4000 ORed with $0000
    ld a,$00
    out ($bf),a
    ld a,$40
    out ($bf),a
    ; 2. Output 16KB of zeroes
    ld bc, $4000    ; Counter for 16KB of VRAM
    ClearVRAMLoop:
        ld a,$00    ; Value to write
        out ($be),a ; Output to VRAM address, which is auto-incremented after each write
        dec bc
        ld a,b
        or c
        jp nz,ClearVRAMLoop

    ;==============================================================
    ; Load palette
    ;==============================================================
    ; 1. Set VRAM write address to CRAM (palette) address 0 (for palette index 0)
    ; by outputting $c000 ORed with $0000
    ld a,$00
    out ($bf),a
    ld a,$c0
    out ($bf),a
    ; 2. Output colour data
    ld hl,PaletteStart
    ld b,(PaletteEnd-PaletteStart)
    ld c,$be
    otir

    ;==============================================================
    ; Load tiles
    ;==============================================================
    ; 1. Set VRAM write address to tile index 0
    ; by outputting $4000 ORed with $0000
    ld a,$00
    out ($bf),a
    ld a,$40
    out ($bf),a
    ; 2. Output tile data
    ld hl,TilesStart              ; Location of tile data
    ld bc,TilesEnd-TilesStart  ; Counter for number of bytes to write
    WriteTilesLoop:
        ; Output data byte then three zeroes, because our tile data is 1 bit
        ; and must be increased to 4 bit
        ld a,(hl)        ; Get data byte
        out ($be),a
        inc hl           ; Add one to hl so it points to the next data byte
        dec bc
        ;soit on fait ca:
        ld a,b
        or c
        jp nz,WriteTilesLoop
        ;soit on fait ca
        ;ld a,b
        ;cp $00
        ;jr nz,WriteTilesLoop
        ;ld a,c
        ;cp $00
        ;jr nz,WriteTilesLoop
        ;le premier va plus vite!
        

    ;==============================================================
    ; Write tilemap data
    ;==============================================================
    ; 1. Set VRAM write address to name table index 0
    ; by outputting $4000 ORed with $3800+0
    ld a,$00
    out ($bf),a
    ld a,$38|$40
    out ($bf),a
    ; 2. Output tilemap data
    ld hl,Tilemap1Start
    ld bc,Tilemap1End-Tilemap1Start  ; Counter for number of bytes to write
    -:
        ld a,(hl)    ; Get data byte
        out ($be),a
        inc hl       ; Point to next tile
        dec bc
        ld a,b
        or c
        jp nz,-


    ; Turn screen on
    ld a,%11000000
;          |||| |`- Zoomed sprites -> 16x16 pixels
;          |||| `-- Doubled sprites -> 2 tiles per sprite, 8x16
;          |||`---- 30 row/240 line mode
;          ||`----- 28 row/224 line mode
;          |`------ VBlank interrupts
;          `------- Enable display
    out ($bf),a
    ld a,$81
    out ($bf),a




    ; Infinite loop to stop program
    xor a
    ld (compteur),a ;init couleur
Loop:
    call WaitForButton
    
  ;  ;update palette
  ;  ; 1. Set VRAM write address to CRAM (palette) address 0 (for palette index 0)
  ;  ; by outputting $c000 ORed with $0000
  ;  ld a,$00;00 pour fond, 01 pour texte
  ;  out ($bf),a
  ;  ld a,$c0
  ;  out ($bf),a
  ;  ; 2. Output colour data
  ;  ld a,(compteur)
  ;  out ($be),a
    ld a,(compteur)
    inc a
    ld (compteur),a
    
    ;draw sprite
    ld a,(compteur)
    ld h,a;x in h
    ld l,a;y in l
    ld d,20;number of the tile in VRAM in d
    ld e,$0;sprite index in e
    call SpriteSet16x16

    jp Loop

WaitForButton:
    push af
      -:in a,($dc)
        and %00010000
        cp  %00000000
        jp nz,-
        ; Button down, wait for it to go up
      -:in a,($dc)
        and %00010000
        cp  %00010000
        jp nz,-
    pop af
    ret


SpriteSet8x8:
  ;x in h
  ;y in l
  ;n in d
  ;sprite index in e
  ;vdp set addr
  ld a, e
  out ($bf), a
  ld a, $7f
  out ($bf), a
  ;y
  ld a, l
  out ($be), a
  ;vdp set addr
  ld a, e
  add a, a
  or $80
  out ($bf), a
  ld a, $7f
  out ($bf), a
  ;x n
  ld a, h
  out ($be), a
  ld a, d
  out ($be), a
ret

SpriteSet16x16:
  ;x in h
  ;y in l
  ;n in d
  ;sprite index in e

  ;vdp set addr
  ld a, e
  out ($bf), a
  ld a, $7f
  out ($bf), a

  ;y+0 y+0
  ;y+8 y+8
  ld a, l
  out ($be), a
  out ($be), a
  add a, $08
  out ($be), a
  out ($be), a

  ;vdp set addr
  ld a, e
  add a, a
  or $80
  out ($bf), a
  ld a, $7f
  out ($bf), a

  ;x+0 n+0 x+8 n+1
  ;x+0 n+2 x+8 n+3
  ld a, h
  out ($be), a
  ld a, d
  out ($be), a

  ld a, h
  add a, $08
  out ($be), a
  inc d
  ld a, d
  out ($be), a

  ld a, h
  out ($be), a
  inc d
  ld a, d
  out ($be), a

  ld a, h
  add a, $08
  out ($be), a
  inc d
  ld a, d
  out ($be), a
ret

;==============================================================
; Data
;==============================================================

; VDP initialisation data
VdpData:
.db $04,$80,$84,$81,$ff,$82,$ff,$85,$ff,$86,$ff,$87,$00,$88,$00,$89,$ff,$8a
VdpDataEnd:


PaletteStart:
.db $3b, $0, $3f, $4, $8, $c, $1, $3, $2b, $20, $30, $38, $f, $1b, $6, $21 ; background
.db $3b, $0, $3f, $4, $8, $c, $1, $3, $2b, $20, $30, $38, $f, $1b, $6, $21 ; sprites
PaletteEnd:


TilesStart:

;Tile 0

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
;Tile 1

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $1 $0
.db $0 $0 $1f $0
.db $0 $0 $ff $0
;Tile 2

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $f $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 3

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $f $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 4

.db $0 $0 $7 $0
.db $0 $0 $7f $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 5

.db $0 $0 $c0 $0
.db $0 $0 $f0 $0
.db $0 $0 $fc $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 6

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $c0 $0
.db $0 $0 $f0 $0
.db $0 $0 $fc $0
.db $0 $0 $ff $0
;Tile 7

.db $0 $0 $1 $0
.db $0 $0 $1 $0
.db $0 $0 $3 $0
.db $0 $0 $3 $0
.db $0 $0 $3 $0
.db $0 $0 $7 $0
.db $0 $0 $7 $0
.db $0 $0 $7 $0
;Tile 8

.db $0 $0 $1 $0
.db $0 $0 $1 $0
.db $0 $0 $3 $0
.db $0 $0 $3 $0
.db $0 $0 $7 $0
.db $0 $0 $7 $0
.db $0 $0 $f $0
.db $0 $0 $f $0
;Tile 9

.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 10

.db $0 $0 $e0 $0
.db $0 $0 $fe $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 11

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $f0 $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 12

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $f0 $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 13

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $80 $0
.db $0 $0 $f8 $0
.db $0 $0 $ff $0
;Tile 14

.db $0 $0 $7 $0
.db $0 $0 $f $0
.db $0 $0 $f $0
.db $0 $0 $f $0
.db $0 $0 $1f $0
.db $0 $0 $1f $0
.db $0 $0 $1f $0
.db $0 $0 $3f $0
;Tile 15

.db $0 $0 $1f $0
.db $0 $0 $1f $0
.db $0 $0 $3f $0
.db $0 $0 $3f $0
.db $0 $0 $7f $0
.db $0 $0 $7f $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 16

.db $0 $0 $c0 $0
.db $0 $0 $f8 $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 17

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $80 $0
.db $0 $0 $f0 $0
.db $0 $0 $fe $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 18

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $e0 $0
.db $0 $0 $fc $0
.db $0 $0 $ff $0
;Tile 19

.db $0 $0 $3f $0
.db $0 $0 $3f $0
.db $0 $0 $3f $0
.db $0 $0 $7f $0
.db $0 $0 $7f $0
.db $0 $0 $7f $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 20

.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $0 $0
.db $0 $0 $3 $0
.db $0 $0 $f $0
.db $0 $0 $3f $0
.db $0 $0 $ff $0
;Tile 21

.db $0 $0 $3 $0
.db $0 $0 $f $0
.db $0 $0 $3f $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 22

.db $0 $0 $80 $0
.db $0 $0 $80 $0
.db $0 $0 $c0 $0
.db $0 $0 $c0 $0
.db $0 $0 $e0 $0
.db $0 $0 $e0 $0
.db $0 $0 $f0 $0
.db $0 $0 $f0 $0
;Tile 23

.db $0 $0 $1 $0
.db $0 $0 $3 $0
.db $0 $0 $7 $0
.db $0 $0 $f $0
.db $0 $0 $1f $0
.db $0 $0 $3f $0
.db $0 $0 $7f $0
.db $0 $0 $ff $0
;Tile 24

.db $0 $0 $f8 $0
.db $0 $0 $f8 $0
.db $0 $0 $fc $0
.db $0 $0 $fc $0
.db $0 $0 $fe $0
.db $0 $0 $fe $0
.db $0 $0 $ff $0
.db $0 $0 $ff $0
;Tile 25

.db $0 $0 $80 $0
.db $0 $0 $c0 $0
.db $0 $0 $e0 $0
.db $0 $0 $f0 $0
.db $0 $0 $f8 $0
.db $0 $0 $fc $0
.db $0 $0 $fe $0
.db $0 $0 $ff $0
TilesEnd:


Tilemap1Start:

.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000
.dw $0000 $0000 $0000 $0000 $0001 $0002 $0003 $0004 $0005 $0006 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0007
.dw $0000 $0000 $0000 $0008 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $000a $000b $000c $000d $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $000e
.dw $0000 $0000 $0000 $000f $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0010 $0011 $0012 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0013
.dw $0000 $0014 $0015 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0016 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0008 $0009
.dw $0017 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0018 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $000f $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0019 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0000 $0014 $0015 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0016 $0000 $0000 $0000 $0000 $0000 $0000 $0017 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0018 $0000 $0000 $0000 $0000 $0000 $0008 $0009 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0019 $0000 $0000 $0000 $0000 $000f $0009 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009
.dw $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009 $0009
Tilemap1End:
